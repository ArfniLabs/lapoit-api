<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.lapoit.api.mapper.UserGameMapper">

    <!-- 중복 참가 체크 -->
    <select id="existsByPlayGameIdAndUserId" resultType="boolean">
        SELECT EXISTS (
        SELECT 1
        FROM user_game
        WHERE play_game_id = #{playGameId}
        AND id = #{userId}
        )
    </select>

    <!-- 게임 참가 -->
    <insert id="insertUserGame">
        INSERT INTO user_game (
        play_game_id,
        id,
        game_id,
        store_id,
        attendance_date,
        status,
        rebuyin_count
        )
        VALUES (
        #{playGameId},
        #{userId},
        #{gameId},
        #{storeId},
        #{attendanceDate},
        'ALIVE',
        0
        )
    </insert>


    <!-- 참가자 목록 조회 -->
    <select id="findPlayersByPlayGameId"
            parameterType="long"
            resultType="com.lapoit.api.dto.playgame.UserGamePlayerDto">

        SELECT
        u.id             AS userId,
        u.user_nickname  AS nickname,
        u.user_name      AS name
        FROM user_game ug
        JOIN user u
        ON ug.id = u.id
        WHERE ug.play_game_id = #{playGameId}

    </select>




    <select id="isOutPlayer" resultType="boolean">
        SELECT status = 'OUT'
        FROM user_game
        WHERE play_game_id = #{playGameId}
        AND id = #{userId}
    </select>


    <update id="outPlayer">
        UPDATE user_game
        SET status = 'OUT'
        WHERE play_game_id = #{playGameId}
        AND id = #{userId}
    </update>

    <update id="increaseRebuyCount">
        UPDATE user_game
        SET rebuyin_count = rebuyin_count + 1
        WHERE user_game_id = #{userGameId}
    </update>

    <update id="reviveUser">
        UPDATE user_game
        SET status = 'ALIVE'
        WHERE user_game_id = #{userGameId}
    </update>

    <update id="updateStatus">
        UPDATE user_game
        SET status = #{status}
        WHERE user_game_id = #{userGameId}
    </update>

    <select id="findByPlayGameIdAndUserId"
            resultType="com.lapoit.api.domain.UserGame">
        SELECT
        user_game_id    AS userGameId,
        id              AS id,
        play_game_id    AS playGameId,
        game_id         AS gameId,
        store_id        AS storeId,
        attendance_date AS attendanceDate,
        status,
        rebuyin_count   AS rebuyinCount
        FROM user_game
        WHERE play_game_id = #{playGameId}
        AND id = #{userId}
    </select>


    <update id="decreaseRebuyCount">
        UPDATE user_game
        SET rebuyin_count = rebuyin_count - 1
        WHERE user_game_id = #{userGameId}
    </update>

    <update id="markDie">
        UPDATE user_game
        SET status = 'DIE'
        WHERE user_game_id = #{userGameId}
    </update>

    <select id="existsAttendanceToday" resultType="boolean">
        SELECT COUNT(1)
        FROM user_game
        WHERE id = #{userId}
        AND attendance_date = #{today}
    </select>


    <!-- ===============================
             개인 출석 조회
             =============================== -->
    <select id="findAttendanceDatesByUserAndMonth"
            resultType="java.time.LocalDate">

        SELECT DISTINCT attendance_date
        FROM user_game
        WHERE id = #{userId}
        AND attendance_date BETWEEN
        DATE(#{startDate})
        AND DATE(#{endDate})
        ORDER BY attendance_date ASC

    </select>


    <!-- ===============================
         관리자 지점별 출석 랭킹
         =============================== -->
    <select id="findAttendanceRankingByStore"
            resultType="com.lapoit.api.dto.attendance.AttendanceRankingRow">
        SELECT
        u.id AS userId,
        u.user_name AS name,
        u.user_nickname AS nickname,
        COUNT(DISTINCT ug.attendance_date) AS attendanceCount
        FROM user_game ug
        JOIN user u ON ug.id = u.id
        WHERE ug.store_id = #{storeId}
        AND ug.attendance_date BETWEEN #{startDate} AND #{endDate}
        GROUP BY u.id
        HAVING attendanceCount >= 1
        ORDER BY attendanceCount DESC
    </select>


</mapper>
